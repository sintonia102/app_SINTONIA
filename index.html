<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINTONIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* CSS Variables for light and dark themes */
        :root {
            --bg-light: #f0f2f5;
            --text-light: #1c1e21;
            --card-light: #ffffff;
            --primary-light: #1877f2;
            --shadow-light: rgba(0, 0, 0, 0.1);

            --bg-dark: #121212;
            --text-dark: #e4e6eb;
            --card-dark: #1e1e1e;
            --primary-dark: #2596be;
            --shadow-dark: rgba(255, 255, 255, 0.1);
        }
        
        /* Styles for light theme */
        html.light {
            --bg-color: var(--bg-light);
            --text-color: var(--text-light);
            --card-color: var(--card-light);
            --primary-color: var(--primary-light);
            --shadow-color: var(--shadow-light);
        }

        /* Styles for dark theme */
        html.dark {
            --bg-color: var(--bg-dark);
            --text-color: var(--text-dark);
            --card-color: var(--card-dark);
            --primary-color: var(--primary-dark);
            --shadow-color: var(--shadow-dark);
        }

        /* General body styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Styles for cards (elements with shadow and background) */
        .card {
            background-color: var(--card-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background-color 0.3s;
        }

        /* Styles for icon buttons */
        .btn-icon {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
        }

        /* Hover effect for icon buttons */
        .btn-icon:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* Active style for icon buttons */
        .btn-icon.active {
            color: var(--primary-color);
        }

        /* Styles for primary buttons */
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        /* Hover effect for primary buttons */
        .btn-primary:hover {
            opacity: 0.9;
        }

        /* Styles for audio visualizer (canvas) */
        #player-display {
            position: relative; /* Required for absolute positioning of children */
            width: 100%;
            aspect-ratio: 16 / 9; 
            background-color: #000; /* Background for when neither canvas nor video are filling */
            border-radius: 0.5rem;
            overflow: hidden;
        }

        #visualizer {
            width: 100%;
            height: 100%;
        }

        /* Styles for video container (ADJUSTED FOR NEW POSITION) */
        /* These classes will be applied to videoContainer when dynamically created */
        .video-container-dynamic {
            position: absolute; /* To overlap the visualizer */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Styles for video iframe */
        .video-container-dynamic iframe {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }

        /* Fade animation for ephemerides */
        .efemeride-fade {
            animation: fadeInOut 8s infinite; /* Keep animation for transition when phrase loads */
        }

        /* Keyframes for fade animation */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            15%, 85% { opacity: 1; }
        }

        /* Styles for theme toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Styles for message box */
        .message-box {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #4CAF50; /* Success color */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message-box.error {
            background-color: #f44336; /* Error color */
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen w-full flex flex-col items-center justify-center p-4">
        
        <main class="card w-full max-w-lg rounded-xl p-4 sm:p-6 space-y-4">
            
            <!-- Application Header -->
            <header class="flex justify-between items-center">
                <h1 class="text-3xl font-bold" style="color: var(--primary-color);">SINTONIA</h1>
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-sun text-yellow-400"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <i class="fa-solid fa-moon text-indigo-400"></i>
                </div>
            </header>

            <!-- Player Screen (VU meter or video) -->
            <div id="player-display" class="relative w-full rounded-lg overflow-hidden">
                <canvas id="visualizer"></canvas>
            </div>
            
            <!-- Motivational Phrases Footer (daily change) -->
            <div id="motivational-phrase-container" class="mt-4 p-3 rounded-lg text-center flex flex-col items-center justify-center" style="background: linear-gradient(45deg, var(--primary-color), #4a00e0);">
                <div id="motivational-phrase-content" class="text-white font-semibold text-sm">
                    <!-- Motivational phrase will be injected here -->
                </div>
            </div>

            <!-- Current Station Label -->
            <div id="station-display-container" class="text-center -mt-2">
                 <p id="current-station-label" class="text-sm font-semibold opacity-80"></p>
            </div>

            <!-- Audio element (hidden) -->
            <audio id="radio-player" crossorigin="anonymous"></audio>

            <!-- Radio Controls -->
            <div class="flex flex-col space-y-4" id="radio-controls">
                <div class="flex items-center justify-center space-x-4">
                    <button id="play-pause-btn" class="text-4xl w-16 h-16 flex items-center justify-center rounded-full btn-primary shadow-lg">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-volume-down"></i>
                    <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    <i class="fas fa-volume-up"></i>
                </div>
            </div>
            
            <!-- Action Icons -->
            <div class="grid grid-cols-4 sm:grid-cols-6 gap-2 text-center text-xs">
                 <div class="flex flex-col items-center">
                    <button id="change-source-btn" class="btn-icon text-2xl"><i class="fa-solid fa-music"></i></button>
                    <span>Cambiar</span>
                </div>
                <div class="flex flex-col items-center">
                    <button id="vumeter-toggle-btn" class="btn-icon text-2xl"><i class="fa-solid fa-sliders"></i></button>
                    <span>VÃºmetro</span>
                </div>
                <div class="flex flex-col items-center">
                    <button id="video-toggle-btn" class="btn-icon text-2xl"><i class="fa-solid fa-tv"></i></button>
                    <span id="video-toggle-label">Ver TV</span>
                </div>
                <div class="flex flex-col items-center">
                     <button id="like-btn" class="btn-icon text-2xl">
                        <i class="far fa-heart"></i>
                    </button>
                    <span id="like-count">0</span>
                </div>
                <div class="flex flex-col items-center">
                    <button id="share-btn" class="btn-icon text-2xl"><i class="fa-solid fa-share-nodes"></i></button>
                    <span>Compartir</span>
                </div>
                 <div class="flex flex-col items-center">
                    <a href="http://www.sintonia102.com" target="_blank" class="btn-icon text-2xl"><i class="fa-solid fa-globe"></i></a>
                    <span>Web</span>
                </div>
            </div>

            <!-- New container for Ephemerides (below icons) -->
            <div id="daily-efemerides-display" class="mt-4 space-y-2">
                <!-- Daily ephemerides with their colors will be injected here -->
                <p class="text-center text-gray-500 text-sm">Cargando efemÃ©rides del dÃ­a...</p>
            </div>

            <!-- Schedulers -->
            <div class="space-y-4 pt-4 border-t border-[var(--shadow-color)]">
                <!-- Start scheduler -->
                <div class="flex items-center justify-between">
                     <div class="flex items-center space-x-2">
                        <i class="far fa-clock"></i>
                        <input type="datetime-local" id="start-time-input" class="p-1 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                    </div>
                    <button id="set-start-btn" class="btn-primary px-3 py-1 text-sm rounded-md">Programar</button>
                </div>
                 <!-- Stop scheduler -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-stopwatch"></i>
                        <input type="number" id="stop-time-input" placeholder="Minutos" class="p-1 w-24 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                    </div>
                    <button id="set-stop-btn" class="btn-primary px-3 py-1 text-sm rounded-md">Apagar en</button>
                </div>
            </div>
            
             <!-- Message box (for notifications) -->
             <div id="message-box" class="message-box hidden"></div>

        </main>
    </div>

    <script type="module">
        // Import necessary functions from Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Elements (Declared at the beginning to avoid ReferenceError) ---
            const radioPlayer = document.getElementById('radio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const volumeSlider = document.getElementById('volume-slider');
            const changeSourceBtn = document.getElementById('change-source-btn');
            const vumeterToggleBtn = document.getElementById('vumeter-toggle-btn');
            const videoToggleBtn = document.getElementById('video-toggle-btn');
            const videoToggleLabel = document.getElementById('video-toggle-label');
            const likeBtn = document.getElementById('like-btn');
            const likeCountSpan = document.getElementById('like-count');
            const shareBtn = document.getElementById('share-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const messageBox = document.getElementById('message-box');
            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            const currentStationLabel = document.getElementById('current-station-label');
            const playerDisplay = document.getElementById('player-display'); 

            const startTimeInput = document.getElementById('start-time-input');
            const setStartBtn = document.getElementById('set-start-btn');
            const stopTimeInput = document.getElementById('stop-time-input');
            const setStopBtn = document.getElementById('set-stop-btn');

            // Elements for motivational phrases footer
            const motivationalPhraseContentDiv = document.getElementById('motivational-phrase-content');
            // Elements for daily ephemerides footer
            const dailyEfemÃ©ridesDisplay = document.getElementById('daily-efemerides-display');
            
            // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyDomYzzPU9zxP9KdMGKvOrrNlwt0RLVE7Y",
                authDomain: "appsintonia-66989.firebaseapp.com",
                projectId: "appsintonia-66989",
                storageBucket: "appsintonia-66989.firebasestorage.app",
                messagingSenderId: "61116779380",
                appId: "1:61116779380:web:e42c0f702296b17b153a21"
            };
            
            const appIdForFirestore = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;

            let app, db, auth;
            let userId = 'anonymous'; 
            let globalLikeDocRef = null; 

            // Function to display messages
            function showMessage(text, isError = false, duration = 3000) {
                messageBox.textContent = text;
                messageBox.classList.remove('hidden', 'show', 'error');
                if (isError) {
                    messageBox.classList.add('error');
                }
                // Force a reflow to ensure the transition plays
                void messageBox.offsetWidth; 
                messageBox.classList.add('show');

                setTimeout(() => {
                    messageBox.classList.remove('show');
                    // Hide completely after transition
                    setTimeout(() => messageBox.classList.add('hidden'), 300); 
                }, duration);
            }

            try {
                const currentFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        globalLikeDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/radioLikes/globalLikeCount`);
                        setupLikesListener();
                        loadDailyEfemÃ©rides(); // Load ephemerides on start and authentication
                    } else {
                        console.log("No user is signed in.");
                        userId = 'anonymous';
                        showMessage("No se pudo autenticar en Firebase. Algunas funciones pueden estar limitadas.", true, 5000);
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase or authenticating:", e);
                showMessage("Error al iniciar la base de datos (Firebase). Algunas funciones pueden no estar disponibles. Por favor, verifica tu configuraciÃ³n de Firebase en el cÃ³digo y las reglas de seguridad.", true, 10000);
            }

            // --- Audio Streams ---
            const streams = [
                { name: "SINTONIA", url: "https://stream.radioservice.org/8046/stream" },
                { name: "ZENO FM", url: "https://stream.zeno.fm/40x1zezb7nhvv" }
            ];
            let currentStreamIndex = 0;

            // --- VU Meter (Visualizer) Configuration ---
            let audioCtx;
            let analyser;
            let source;
            let dataArray;
            let bufferLength;
            let currentVumeterEffect = 0;
            const totalVumeterEffects = 10;
            let animationFrameId;

            // --- Motivational Phrases ---
            const motivationalPhrases = [
                "Cree que puedes y ya estÃ¡s a medio camino.", "El mejor momento para plantar un Ã¡rbol fue hace 20 aÃ±os. El segundo mejor momento es ahora.", "Tu actitud, no tu aptitud, determinarÃ¡ tu altitud.", "El Ã©xito es la suma de pequeÃ±os esfuerzos repetidos dÃ­a tras dÃ­a.", "La Ãºnica forma de hacer un gran trabajo es amar lo que haces.", "Cada maÃ±ana nacemos de nuevo. Lo que hacemos hoy es lo que mÃ¡s importa.", "No cuentes los dÃ­as, haz que los dÃ­as cuenten.", "La felicidad no es algo hecho. Proviene de tus propias acciones.", "El futuro pertenece a quienes creen en la belleza de sus sueÃ±os.", "Un dÃ­a brillante depende mÃ¡s de tu actitud que del sol.", "No te preocupes por los fracasos, preocÃºpate por las oportunidades que pierdes cuando ni siquiera lo intentas.", "Convierte los muros que aparecen en tu vida en peldaÃ±os hacia tus objetivos.", "Si la oportunidad no llama, construye una puerta.", "El optimismo es la fe que conduce al logro.", "Empieza donde estÃ¡s. Usa lo que tienes. Haz lo que puedes.", "La vida es 10% lo que te pasa y 90% cÃ³mo reaccionas.", "La persona que dice que no se puede hacer no deberÃ­a interrumpir a la persona que lo estÃ¡ haciendo.", "Hoy es una nueva oportunidad para ser mejor que ayer.", "No dejes que el miedo a perder sea mayor que la emociÃ³n de ganar.", "El secreto para salir adelante es empezar.", "La disciplina es el puente entre las metas y los logros.", "Solo aquellos que se atreven a tener grandes fracasos terminan logrando grandes Ã©xitos.", "La vida se encoge o se expande en proporciÃ³n a tu coraje.", "Tu Ãºnica limitaciÃ³n es tu propia imaginaciÃ³n.", "No esperes. El momento nunca serÃ¡ el \"justo\".", "La magia es creer en ti mismo. Si puedes hacer eso, puedes hacer que cualquier cosa suceda.", "Un pequeÃ±o pensamiento positivo por la maÃ±ana puede cambiar todo tu dÃ­a.", "Cae siete veces, levÃ¡ntate ocho.", "Haz de cada dÃ­a tu obra maestra.", "La perseverancia no es una carrera larga; son muchas carreras cortas una tras otra.", "No importa lo lento que vayas, siempre y cuando no te detengas.", "El que puede cambiar sus pensamientos puede cambiar su destino.", "La mejor venganza es un Ã©xito masivo.", "Lo que la mente del hombre puede concebir y creer, puede lograr.", "La acciÃ³n es la clave fundamental de todo Ã©xito.", "Eres mÃ¡s valiente de lo que crees, mÃ¡s fuerte de lo que pareces y mÃ¡s inteligente de lo que piensas.", "Las estrellas no pueden brillar sin oscuridad.", "Tu energÃ­a presenta a las personas antes de que hables.", "No es la montaÃ±a que conquistamos, sino a nosotros mismos.", "El dolor que sientes hoy serÃ¡ la fuerza que sentirÃ¡s maÃ±ana.", "La vida es como andar en bicicleta. Para mantener el equilibrio, debes seguir moviÃ©ndote.", "No mires el reloj; haz lo que Ã©l hace. Sigue moviÃ©ndote.", "Todo lo que siempre has querido estÃ¡ al otro lado del miedo.", "La clave del Ã©xito es enfocarse en las metas, no en los obstÃ¡culos.", "La duda mata mÃ¡s sueÃ±os que el fracaso.", "Un viaje de mil millas comienza con un solo paso.", "Trabaja duro en silencio y deja que tu Ã©xito haga todo el ruido.", "Si puedes soÃ±arlo, puedes hacerlo.", "La motivaciÃ³n es lo que te pone en marcha. El hÃ¡bito es lo que hace que sigas.", "No se trata de si te derriban, se trata de si te levantas.", "Apunta a la luna. Si fallas, podrÃ­as golpear una estrella.", "Nunca eres demasiado viejo para fijar otra meta o para soÃ±ar un nuevo sueÃ±o.", "La calidad no es un acto, es un hÃ¡bito.", "El carÃ¡cter es poder.", "La mejor manera de predecir el futuro es crearlo.", "SÃ© el cambio que deseas ver en el mundo.", "La alegrÃ­a no estÃ¡ en las cosas, estÃ¡ en nosotros.", "El aprendizaje es un tesoro que seguirÃ¡ a su dueÃ±o a todas partes.", "Lo imposible es solo una opiniÃ³n.", "La mente es todo. En lo que piensas, te conviertes.", "No hay atajos para ningÃºn lugar al que valga la pena ir.", "La simplicidad es la mÃ¡xima sofisticaciÃ³n.", "El que no es lo suficientemente valiente para tomar riesgos no lograrÃ¡ nada en la vida.", "La excelencia no es una habilidad. Es una actitud.", "No puedes tener una vida positiva con una mente negativa.", "La gente olvidarÃ¡ lo que dijiste, la gente olvidarÃ¡ lo que hiciste, pero la gente nunca olvidarÃ¡ cÃ³mo los hiciste sentir.", "Si buscas resultados distintos, no hagas siempre lo mismo.", "La vida es una aventura atrevida o no es nada.", "El momento en que quieres renunciar es el momento en que necesitas seguir insistiendo.", "Cree en los comienzos, incluso despuÃ©s de cien finales.", "La paciencia y la perseverancia tienen un efecto mÃ¡gico ante el cual las dificultades desaparecen y los obstÃ¡culos se desvanecen.", "Tu futuro es creado por lo que haces hoy, no maÃ±ana.", "El optimismo perpetuo es un multiplicador de fuerza.", "Nunca subestimes el poder que tienes para llevar tu vida en una nueva direcciÃ³n.", "La felicidad es una direcciÃ³n, no un lugar.", "Haz algo hoy que tu futuro yo te agradezca.", "El Ãºnico lugar donde el Ã©xito viene antes que el trabajo es en el diccionario.", "Las dificultades a menudo preparan a la gente comÃºn para un destino extraordinario.", "Si no te gusta algo, cÃ¡mbialo. Si no puedes cambiarlo, cambia tu actitud.", "El coraje no siempre ruge. A veces, el coraje es la vocecita al final del dÃ­a que dice: \"MaÃ±ana lo intentarÃ© de nuevo\".", "El universo no te da lo que pides con tus pensamientos; te da lo que exiges con tus acciones.", "Las limitaciones solo viven en nuestras mentes. Pero si usamos nuestra imaginaciÃ³n, nuestras posibilidades se vuelven ilimitadas.", "Tu mente es un imÃ¡n. Si piensas en bendiciones, atraes bendiciones. Si piensas en problemas, atraes problemas.", "Un ganador es un soÃ±ador que nunca se rinde.", "No dejes que tu pasado ocupe demasiado de tu presente.", "El sol es nuevo cada dÃ­a.", "La inspiraciÃ³n existe, pero tiene que encontrarte trabajando.", "Un objetivo sin un plan es solo un deseo.", "El valor es la resistencia al miedo, el dominio del miedo, no la ausencia de miedo.", "No tienes que ser grande para empezar, pero tienes que empezar para ser grande.", "Cada dÃ­a puede no ser bueno, pero hay algo bueno en cada dÃ­a.", "La vida es un eco. Lo que envÃ­as, regresa. Lo que siembras, cosechas.", "La confianza en uno mismo es el primer secreto del Ã©xito.", "Los desafÃ­os son los que hacen la vida interesante y superarlos es lo que hace que la vida tenga sentido.", "SonrÃ­e, es terapia gratuita.", "El fracaso es simplemente la oportunidad de comenzar de nuevo, esta vez de forma mÃ¡s inteligente.", "Todo progresa a travÃ©s del cambio."
            ];

            // --- Application State ---
            let isPlaying = false;
            let isVideoActive = false; 
            let startTimeout, stopTimeout;
            let currentDailyEfemerideInterval; // For rotating ephemerides

            // Configures the audio context for the visualizer
            function setupAudioContext() {
                if (audioCtx) {
                    console.log("AudioContext already exists. Current state:", audioCtx.state);
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume().then(() => {
                            console.log("AudioContext resumed from setupAudioContext.");
                        }).catch(e => {
                            console.error("Error resuming AudioContext in setupAudioContext:", e);
                            showMessage("Error al reanudar el vÃºmetro: " + e.message, true, 5000);
                        });
                    }
                    return;
                }
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 2048; 
                    source = audioCtx.createMediaElementSource(radioPlayer); 
                    source.connect(analyser); 
                    analyser.connect(audioCtx.destination); 
                    bufferLength = analyser.frequencyBinCount; 
                    dataArray = new Uint8Array(bufferLength); 
                    console.log("AudioContext initialized. State:", audioCtx.state);
                } catch (e) {
                    console.error("Error configuring audio context:", e);
                    showMessage("El navegador no soporta el vÃºmetro o hay un problema con el stream (CORS).", true, 5000);
                }
            }

            // --- Audio Controls ---
            function playRadio() {
                if (isPlaying) return; 

                console.log("Attempting to start playRadio()...");

                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log("AudioContext resumed before play().");
                        attemptToPlay();
                    }).catch(e => {
                        console.error("Error resuming AudioContext before play():", e);
                        showMessage("Error al reanudar el audio: " + e.message, true, 5000);
                    });
                } else if (!audioCtx) {
                    setupAudioContext();
                    // Give a moment for context to be created before attempting to play
                    setTimeout(attemptToPlay, 50); 
                } else {
                    attemptToPlay();
                }
            }

            function attemptToPlay() {
                radioPlayer.play().then(() => {
                    console.log("Radio playback started successfully.");
                    isPlaying = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; 

                    if (!isVideoActive && audioCtx && audioCtx.state === 'running') {
                        draw();
                    } else if (audioCtx && audioCtx.state !== 'running') {
                         console.warn("AudioContext is not in 'running' state after play(). VU meter will not start immediately.");
                    }
                }).catch(e => {
                    console.error("Error playing audio:", e);
                    let errorMessage = "No se pudo iniciar la radio. AsegÃºrate de interactuar con la pÃ¡gina primero.";
                    if (e.name === "NotAllowedError") {
                        errorMessage += " (El navegador bloqueÃ³ la reproducciÃ³n automÃ¡tica. Haz clic en el botÃ³n de Play.)";
                    } else if (e.name === "AbortError") {
                        errorMessage += " (La reproducciÃ³n fue abortada, posiblemente por un cambio de fuente rÃ¡pido.)";
                    } else if (e.message.includes("Failed to load because no supported source was found")) {
                        errorMessage += " (URL del stream no vÃ¡lida o problema de CORS.)";
                    }
                    showMessage(errorMessage, true, 6000);
                });
            }


            function pauseRadio() {
                if (!isPlaying) return; 
                radioPlayer.pause();
                cancelAnimationFrame(animationFrameId); 
                isPlaying = false;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; 
            }

            function togglePlayPause() {
                if (isPlaying) {
                    pauseRadio();
                } else {
                    playRadio();
                }
            }
            
            function toggleAudioSource() {
                const wasPlaying = isPlaying; 
                if (wasPlaying) {
                    pauseRadio(); 
                }

                currentStreamIndex = (currentStreamIndex + 1) % streams.length; 
                const newStream = streams[currentStreamIndex]; 

                radioPlayer.src = newStream.url; 
                radioPlayer.load(); 
                updateStationLabel(); 
                showMessage(`Cambiando a ${newStream.name}`, false, 2000);

                if (wasPlaying) {
                    radioPlayer.addEventListener('canplay', () => {
                         playRadio(); 
                    }, { once: true });
                }
            }
            
            function updateStationLabel() {
                 currentStationLabel.textContent = `Ahora suena: ${streams[currentStreamIndex].name}`;
            }
            
            function toggleVideo() {
                isVideoActive = !isVideoActive; 

                let videoContainer = document.getElementById('videoContainer'); 

                if (isVideoActive) {
                    if (isPlaying) {
                        pauseRadio(); 
                    }
                    cancelAnimationFrame(animationFrameId); 
                    
                    canvas.classList.add('hidden');
                    
                    if (!videoContainer) {
                        videoContainer = document.createElement('div');
                        videoContainer.id = 'videoContainer';
                        videoContainer.classList.add('video-container-dynamic'); 
                        playerDisplay.appendChild(videoContainer); 
                    }
                    
                    const iframe = document.createElement('iframe');
                    iframe.src = "https://player.kick.com/sintonia-tv"; 
                    iframe.setAttribute('height', '720');
                    iframe.setAttribute('width', '1280');
                    iframe.setAttribute('frameborder', '0');
                    iframe.setAttribute('scrolling', 'no');
                    iframe.setAttribute('allowfullscreen', 'true');
                    iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture'); 

                    videoContainer.innerHTML = ''; 
                    videoContainer.appendChild(iframe); 

                    videoToggleLabel.textContent = "Escuchar Radio";
                    videoToggleBtn.innerHTML = '<i class="fa-solid fa-radio"></i>';
                } else {
                    if (videoContainer) {
                        videoContainer.remove(); 
                    }

                    canvas.classList.remove('hidden');

                    videoToggleLabel.textContent = "Ver TV";
                    videoToggleBtn.innerHTML = '<i class="fa-solid fa-tv"></i>';
                    
                    playRadio();
                    showMessage("Cambiando a Radio...", false, 3000);
                }
            }

            function changeVumeterEffect() {
                currentVumeterEffect = (currentVumeterEffect + 1) % totalVumeterEffects; 
                showMessage(`VÃºmetro Efecto ${currentVumeterEffect + 1}`, false, 1500); 
            }

            // --- Likes Logic with Firestore ---
            function setupLikesListener() {
                if (globalLikeDocRef && db) { 
                    onSnapshot(globalLikeDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const currentLikes = data.count || 0;
                            likeCountSpan.textContent = `${currentLikes} Me Gusta`;
                            console.log("Likes updated from Firestore:", currentLikes);
                        } else {
                            setDoc(globalLikeDocRef, { count: 0 }).then(() => {
                                likeCountSpan.textContent = `0 Me Gusta`;
                                console.log("Likes document initialized in Firestore.");
                            }).catch(e => {
                                console.error("Error initializing likes:", e);
                            });
                        }
                    }, (error) => {
                        console.error("Error listening to Firestore likes:", error);
                        showMessage("Error de conexiÃ³n con los likes. Los 'Me Gusta' podrÃ­an no actualizarse.", true, 5000);
                    });
                } else {
                    console.warn("Firestore is not available for likes. Check Firebase initialization.");
                    likeCountSpan.textContent = `0 Me Gusta (no persistente)`;
                }
            }
            
            async function handleLike() {
                if (!globalLikeDocRef) {
                    showMessage("La funciÃ³n de 'Me Gusta' no estÃ¡ disponible. Error de conexiÃ³n con la base de datos.", true, 4000);
                    return;
                }
                
                try {
                    await updateDoc(globalLikeDocRef, {
                        count: increment(1) 
                    });
                    console.log("Like incremented in Firestore.");
                    likeBtn.querySelector('i').classList.replace('far', 'fas'); 
                    likeBtn.querySelector('i').classList.add('text-red-500'); 
                } catch (e) {
                    console.error("Error registering like in Firestore:", e);
                    showMessage("Error al registrar tu 'Me Gusta'. Intenta de nuevo.", true, 4000);
                }
            }

            function handleShare() {
                if (navigator.share) { 
                    navigator.share({
                        title: 'SINTONIA Radio',
                        text: 'Â¡EscuchÃ¡ la mejor radio online!',
                        url: window.location.href 
                    }).catch(console.error);
                } else {
                    navigator.clipboard.writeText(window.location.href); 
                    showMessage('Â¡Link copiado al portapapeles!', false, 2000);
                }
            }
            
            function handleThemeToggle() {
                document.documentElement.classList.toggle('dark'); 
                document.documentElement.classList.toggle('light'); 
            }

            // --- Scheduler Logic ---
            setStartBtn.addEventListener('click', () => {
                const startTimeValue = startTimeInput.value;
                if (!startTimeValue) {
                    showMessage("Por favor, selecciona una fecha y hora.", true, 3000);
                    return;
                }
                const targetTime = new Date(startTimeValue).getTime(); 
                const now = new Date().getTime(); 
                const delay = targetTime - now; 

                if (delay <= 0) {
                    showMessage("La hora seleccionada ya pasÃ³.", true, 3000);
                    return;
                }

                clearTimeout(startTimeout); 
                startTimeout = setTimeout(() => {
                    playRadio(); 
                    showMessage("Â¡La radio ha comenzado segÃºn lo programado!", false, 5000);
                }, delay);
                
                showMessage(`Radio programada para iniciar en ${new Date(targetTime).toLocaleString()}`, false, 4000);
            });

            setStopBtn.addEventListener('click', () => {
                const minutes = parseInt(stopTimeInput.value, 10); 
                if (isNaN(minutes) || minutes <= 0) {
                    showMessage("Ingresa un nÃºmero vÃ¡lido de minutos.", true, 3000);
                    return;
                }
                const delay = minutes * 60 * 1000; 

                clearTimeout(stopTimeout); 
                stopTimeout = setTimeout(() => {
                    pauseRadio(); 
                    showMessage("Â¡Temporizador de apagado completado!", false, 5000);
                }, delay);

                showMessage(`La radio se apagarÃ¡ en ${minutes} minuto(s).`, false, 4000);
            });


            // --- Motivational Phrases Logic (formerly Ephemerides) ---
            function loadMotivationalPhrase() { 
                const ONE_DAY_MS = 24 * 60 * 60 * 1000; 

                let lastPhraseIndex = parseInt(localStorage.getItem('lastPhraseIndex') || '0');
                let lastPhraseUpdate = parseInt(localStorage.getItem('lastPhraseUpdate') || '0');
                const now = Date.now();

                if (now - lastPhraseUpdate >= ONE_DAY_MS) {
                    lastPhraseIndex = (lastPhraseIndex + 1) % motivationalPhrases.length;
                    localStorage.setItem('lastPhraseIndex', lastPhraseIndex.toString());
                    localStorage.setItem('lastPhraseUpdate', now.toString());
                    console.log("New motivational phrase selected for the day.");
                } else {
                    console.log("Displaying the same motivational phrase for the day.");
                }
                
                const currentPhrase = motivationalPhrases[lastPhraseIndex];
                motivationalPhraseContentDiv.classList.remove('efemeride-fade'); 
                void motivationalPhraseContentDiv.offsetWidth; 
                motivationalPhraseContentDiv.classList.add('efemeride-fade'); 
                motivationalPhraseContentDiv.textContent = currentPhrase; 
            }

            // --- Logic to display Daily Ephemerides from Firestore ---
            let currentDailyEfemerideIndex = 0;
            let dailyEfemerides = [];
            let dailyEfemeridesIntervalId;

            async function loadDailyEfemÃ©rides() {
                if (!db) {
                    dailyEfemÃ©ridesDisplay.innerHTML = '<p class="text-center text-gray-500 text-sm">Base de datos no disponible para efemÃ©rides.</p>';
                    return;
                }

                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const docKey = `${month}-${day}`;

                // Path: artifacts/{appId}/public/data/dailyEfemÃ©rides/{MM-DD}
                const docRef = doc(db, `artifacts/${appIdForFirestore}/public/data/dailyEfemÃ©rides/${docKey}`);

                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        dailyEfemerides = docSnap.data().events || [];
                        if (dailyEfemerides.length > 0) {
                            startDailyEfemeridesRotation();
                        } else {
                            dailyEfemÃ©ridesDisplay.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay efemÃ©rides para hoy.</p>';
                        }
                    } else {
                        dailyEfemÃ©ridesDisplay.innerHTML = '<p class="text-center text-gray-500 text-sm">No se encontraron efemÃ©rides para hoy.</p>';
                        console.log(`No ephemerides document found for ${docKey}.`);
                    }
                } catch (e) {
                    console.error("Error loading daily ephemerides from Firestore:", e);
                    dailyEfemÃ©ridesDisplay.innerHTML = '<p class="text-center text-red-500 text-sm">Error al cargar efemÃ©rides diarias.</p>';
                    showMessage("Error al cargar efemÃ©rides diarias. Revisa la consola para mÃ¡s detalles.", true, 5000);
                }
            }

            function startDailyEfemeridesRotation() {
                if (dailyEfemeridesIntervalId) {
                    clearInterval(dailyEfemeridesIntervalId);
                }

                if (dailyEfemerides.length === 0) {
                    dailyEfemÃ©ridesDisplay.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay efemÃ©rides disponibles para rotar.</p>';
                    return;
                }

                currentDailyEfemerideIndex = 0; // Reset index when starting rotation

                function updateDailyEfemerideDisplay() {
                    const efemeride = dailyEfemerides[currentDailyEfemerideIndex];
                    if (efemeride) {
                        dailyEfemÃ©ridesDisplay.innerHTML = `
                            <div style="background-color: ${efemeride.bgColor || '#6B7280'}; padding: 0.75rem; border-radius: 0.5rem; text-align: center; color: white; font-weight: 600;">
                                ${efemeride.text}
                            </div>
                        `;
                    } else {
                         dailyEfemÃ©ridesDisplay.innerHTML = '<p class="text-center text-gray-500 text-sm">EfemÃ©ride no encontrada.</p>';
                    }
                    currentDailyEfemerideIndex = (currentDailyEfemerideIndex + 1) % dailyEfemerides.length;
                }

                updateDailyEfemerideDisplay(); // Show the first one immediately
                dailyEfemÃ©ridesIntervalId = setInterval(updateDailyEfemerideDisplay, 8000); // Change every 8 seconds
            }


            // --- VU Meter Drawing Functions --- 
            function draw() {
                if (!isPlaying || isVideoActive || !audioCtx || audioCtx.state !== 'running' || !analyser || !dataArray) {
                    cancelAnimationFrame(animationFrameId);
                    return;
                }
                animationFrameId = requestAnimationFrame(draw); 
                analyser.getByteFrequencyData(dataArray); 
                canvasCtx.fillStyle = '#000'; 
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height); 

                switch (currentVumeterEffect) {
                    case 0: drawBars(); break; case 1: drawCircular(); break; case 2: drawWave(); break; case 3: drawSunburst(); break; case 4: drawGalaxy(); break; case 5: drawTunnel(); break; case 6: drawReflectedBars(); break; case 7: drawParticleWeb(); break; case 8: drawColorBlocks(); break; case 9: drawTexturedLines(); break;
                }
            }
            
            // Draws vertical audio bars
            const drawBars = () => {
                const barWidth = (canvas.width / bufferLength) * 2.5; 
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i]; 
                    const hue = i * 2; 
                    canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight); 
                    x += barWidth + 1; 
                }
            };

            // Draws circular bars from the center
            const drawCircular = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) * 0.4; 
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2; 
                    const angle = (i / bufferLength) * 2 * Math.PI; 
                    const xStart = centerX + radius * Math.cos(angle);
                    const yStart = centerY + radius * Math.sin(angle);
                    const xEnd = centerX + (radius + barHeight) * Math.cos(angle);
                    const yEnd = centerY + (radius + barHeight) * Math.sin(angle);
                    const hue = i * 3; 
                    canvasCtx.strokeStyle = `hsl(${hue}, 100%, 70%)`;
                    canvasCtx.lineWidth = 2;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(xStart, yStart);
                    canvasCtx.lineTo(xEnd, yEnd);
                    canvasCtx.stroke();
                }
            };
            
            // Draws a time wave
            const drawWave = () => {
                analyser.getByteTimeDomainData(dataArray); 
                canvasCtx.lineWidth = 2;
                const hue = Date.now() / 20 % 360; 
                canvasCtx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
                canvasCtx.beginPath();
                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0; 
                    const y = v * canvas.height / 2; 
                    if (i === 0) {
                        canvasCtx.moveTo(x, y);
                    } else {
                        canvasCtx.lineTo(x, y);
                    }
                    x += sliceWidth;
                }
                canvasCtx.lineTo(canvas.width, canvas.height / 2);
                canvasCtx.stroke();
            };

            // Draws a sunburst effect
            const drawSunburst = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                for (let i = 0; i < bufferLength; i+=4) { 
                    const barHeight = dataArray[i] * 1.5; 
                    const angle = (i / bufferLength) * Math.PI * 2; 
                    const hue = angle * 60; 
                    canvasCtx.save(); 
                    canvasCtx.translate(centerX, centerY); 
                    canvasCtx.rotate(angle); 
                    const gradient = canvasCtx.createLinearGradient(0, 0, barHeight, 0); 
                    gradient.addColorStop(0, `hsl(${hue}, 100%, 20%)`);
                    gradient.addColorStop(1, `hsl(${hue}, 100%, 70%)`);
                    canvasCtx.strokeStyle = gradient;
                    canvasCtx.lineWidth = 3;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(0, 0);
                    canvasCtx.lineTo(barHeight, 0);
                    canvasCtx.stroke();
                    canvasCtx.restore(); 
                }
            };
            
            // Draws a galaxy effect with particles
            const drawGalaxy = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                for (let i = 0; i < bufferLength; i++) {
                    const value = dataArray[i];
                    if (value > 100) { 
                        const radius = (value / 255) * Math.min(centerX, centerY) * 1.2; 
                        const angle = (i / bufferLength) * 2 * Math.PI + (Date.now() / 10000); 
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
                        const hue = i * 2.5; 
                        canvasCtx.fillStyle = `hsla(${hue}, 100%, 80%, ${value/255})`; 
                        canvasCtx.beginPath();
                        canvasCtx.arc(x, y, value/100, 0, Math.PI * 2); 
                        canvasCtx.fill();
                    }
                }
            };

            // Draws a concentric tunnel effect
            const drawTunnel = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                for (let i = 0; i < bufferLength; i+=8) { 
                    const value = dataArray[i];
                    const radius = (i / bufferLength) * (centerX * 0.8) + (value / 5); 
                    if (radius > centerX) return; 
                    const hue = value; 
                    canvasCtx.strokeStyle = `hsla(${hue}, 100%, 60%, 0.5)`; 
                    canvasCtx.lineWidth = 2;
                    canvasCtx.beginPath();
                    canvasCtx.arc(centerX, centerY, radius, 0, Math.PI * 2); 
                    canvasCtx.stroke();
                }
            };

            // Draws bars with vertical reflection
            const drawReflectedBars = () => {
                const barWidth = canvas.width / bufferLength;
                const centerY = canvas.height / 2;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2; 
                    const hue = i * 2; 
                    const gradient = canvasCtx.createLinearGradient(0, centerY - barHeight, 0, centerY + barHeight); 
                    gradient.addColorStop(0, `hsl(${hue}, 100%, 50%)`);
                    gradient.addColorStop(0.5, `hsl(${hue}, 80%, 30%)`);
                    gradient.addColorStop(1, `hsl(${hue}, 100%, 50%)`);
                    canvasCtx.fillStyle = gradient;
                    canvasCtx.fillRect(i * barWidth, centerY - barHeight, barWidth, barHeight * 2); 
                }
            };
            
            // Draws a connected particle web
            const drawParticleWeb = () => {
                let particles = [];
                for(let i = 0; i < bufferLength; i+=8) { 
                    const value = dataArray[i];
                    if (value > 50) { 
                        const angle = (i / bufferLength) * Math.PI * 2;
                        const distance = value * 1.5;
                        particles.push({ 
                            x: canvas.width/2 + Math.cos(angle) * distance,
                            y: canvas.height/2 + Math.sin(angle) * distance,
                            hue: i*2
                        });
                    }
                }
                for(let i=0; i<particles.length; i++) {
                    for(let j=i; j<particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx*dx + dy*dy); 
                        if(dist < 50) { 
                            canvasCtx.strokeStyle = `hsla(${particles[i].hue}, 100%, 70%, ${1 - dist/50})`; 
                            canvasCtx.beginPath();
                            canvasCtx.moveTo(particles[i].x, particles[i].y);
                            canvasCtx.lineTo(particles[j].x, particles[j].y);
                            canvasCtx.stroke();
                        }
                    }
                }
            };

            // Draws a color block pattern
            const drawColorBlocks = () => {
                const blockSize = canvas.width / 16; 
                for (let i = 0; i < 16; i++) {
                    for (let j = 0; j < 9; j++) {
                        const dataIndex = Math.floor((i*16 + j) / (16*9) * bufferLength); 
                        const value = dataArray[dataIndex];
                        const hue = value * 1.5; 
                        canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                        canvasCtx.fillRect(i * blockSize, j * blockSize, blockSize-1, blockSize-1); 
                    }
                }
            };
            
            // Draws textured lines rising from the bottom
            const drawTexturedLines = () => {
                for (let i = 0; i < bufferLength; i += 4) { 
                    const value = dataArray[i];
                    const y = canvas.height - value; 
                    const hue = 180 + (value / 255) * 180; 
                    const gradient = canvasCtx.createLinearGradient(i * 3, y, i * 3, canvas.height); 
                    gradient.addColorStop(0, `hsla(${hue}, 100%, 70%, ${value / 255})`);
                    gradient.addColorStop(1, `hsla(${hue}, 100%, 50%, 0)`);
                    canvasCtx.fillStyle = gradient;
                    canvasCtx.fillRect(i * 3, y, 2, canvas.height - y); 
                }
            };
            
            // --- Initialization ---
            function init() {
                radioPlayer.src = streams[currentStreamIndex].url; 
                updateStationLabel(); 
                
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                    themeToggle.checked = false; 
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                } else {
                    themeToggle.checked = true; 
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                }
                loadMotivationalPhrase(); // Load the motivational phrase
                // loadDailyEfemÃ©rides() is called after Firebase authentication

                canvas.width = playerDisplay.clientWidth;
                canvas.height = playerDisplay.clientHeight;
                window.addEventListener('resize', () => {
                    canvas.width = playerDisplay.clientWidth;
                    canvas.height = playerDisplay.clientHeight;
                });

                // Add event listener for audio errors
                radioPlayer.addEventListener('error', (e) => {
                    console.error("Error en el reproductor de audio:", e);
                    let errorMessage = "Error en la reproducciÃ³n de audio.";
                    switch (e.target.error.code) {
                        case e.target.error.MEDIA_ERR_ABORTED:
                            errorMessage += " La carga de audio fue abortada.";
                            break;
                        case e.target.error.MEDIA_ERR_NETWORK:
                            errorMessage += " Error de red al descargar el audio.";
                            break;
                        case e.target.error.MEDIA_ERR_DECODE:
                            errorMessage += " Error al decodificar el audio.";
                            break;
                        case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMessage += " La fuente de audio no es compatible o no se pudo encontrar.";
                            break;
                        default:
                            errorMessage += " Error desconocido.";
                            break;
                    }
                    showMessage(errorMessage, true, 8000);
                });
            }

            init(); 
        });
    </script>
</body>
</html>
