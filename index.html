<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINTONIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* CSS Variables for light and dark themes */
        :root {
            --bg-light: #f0f2f5;
            --text-light: #1c1e21;
            --card-light: #ffffff;
            --primary-light: #1877f2;
            --shadow-light: rgba(0, 0, 0, 0.1);

            --bg-dark: #121212;
            --text-dark: #e4e6eb;
            --card-dark: #1e1e1e;
            --primary-dark: #2596be;
            --shadow-dark: rgba(255, 255, 255, 0.1);
        }
        
        /* Styles for light theme */
        html.light {
            --bg-color: var(--bg-light);
            --text-color: var(--text-light);
            --card-color: var(--card-light);
            --primary-color: var(--primary-light);
            --shadow-color: var(--shadow-color);
        }

        /* Styles for dark theme */
        html.dark {
            --bg-color: var(--bg-dark);
            --text-color: var(--text-dark);
            --card-color: var(--card-dark);
            --primary-color: var(--primary-dark);
            --shadow-color: var(--shadow-color);
        }

        /* General body styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Styles for cards (elements with shadow and background) */
        .card {
            background-color: var(--card-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background-color 0.3s;
        }

        /* Styles for icon buttons */
        .btn-icon {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
        }

        /* Hover effect for icon buttons */
        .btn-icon:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* Active style for icon buttons */
        .btn-icon.active {
            color: var(--primary-color);
        }

        /* Styles for primary buttons */
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        /* Hover effect for primary buttons */
        .btn-primary:hover {
            opacity: 0.9;
        }

        /* Styles for audio visualizer (canvas) */
        #player-display {
            position: relative; /* Required for absolute positioning of children */
            width: 100%;
            aspect-ratio: 16 / 9; 
            background-color: #000; /* Background for when neither canvas nor video are filling */
            border-radius: 0.5rem;
            overflow: hidden;
        }

        #visualizer {
            width: 100%;
            height: 100%;
        }

        /* Styles for video container */
        .video-container-dynamic {
            position: absolute; /* To overlap the visualizer */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Styles for video iframe */
        .video-container-dynamic iframe {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }

        /* Fade animation for ephemerides and phrases */
        .efemeride-fade {
            animation: fadeInOut 8s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            15%, 85% { opacity: 1; }
        }

        /* Styles for theme toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Styles for message box */
        .message-box {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #4CAF50; /* Success color */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message-box.error {
            background-color: #f44336; /* Error color */
        }

        /* Styles for official messages */
        .official-message {
            border: 2px solid var(--primary-color);
            background-color: var(--primary-color); /* Use primary color for background */
            color: white; /* Ensure text is white for contrast */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Styles for active admin button */
        .admin-active-btn {
            background-color: var(--primary-color) !important; 
            color: white !important; 
            border: 2px solid white !important; 
            display: inline-flex !important; 
            align-items: center;
            justify-content: center;
            padding: 0.5rem; 
            border-radius: 9999px; 
        }

        /* Styles for like button in messages */
        .message-like-btn {
            color: var(--text-color);
            transition: color 0.2s;
        }
        .message-like-btn.liked {
            color: #ef4444; /* Red for liked */
        }
        .message-like-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Styles for dislike button in messages */
        .message-dislike-btn {
            color: var(--text-color);
            transition: color 0.2s;
        }
        .message-dislike-btn.disliked {
            color: #3b82f6; /* Blue for disliked */
        }
        .message-dislike-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen w-full flex flex-col items-center justify-center p-4">
        
        <main class="card w-full max-w-lg rounded-xl p-4 sm:p-6 space-y-4">
            
            <!-- Application Header -->
            <header class="flex justify-between items-center">
                <h1 class="text-3xl font-bold" style="color: var(--primary-color);">SINTONIA</h1>
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-sun text-yellow-400"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <i class="fa-solid fa-moon text-indigo-400"></i>
                    <!-- Admin Toggle Button -->
                    <button id="admin-toggle-btn" class="btn-icon text-xl ml-4 hidden" title="Modo Administrador">
                        <i class="fa-solid fa-user-shield"></i>
                    </button>
                    <!-- New: Google Sign-in button for admin (now an icon) -->
                    <button id="sign-in-google-btn" class="btn-icon text-xl ml-4 hidden" title="Iniciar Sesión Administrador">
                        <i class="fa-solid fa-lock"></i>
                    </button>
                </div>
            </header>

            <!-- Player Screen (VU meter or video) -->
            <div id="player-display" class="relative w-full rounded-lg overflow-hidden">
                <canvas id="visualizer"></canvas>
            </div>
            
            <!-- Motivational Phrases Footer (daily change) -->
            <div id="motivational-phrase-container" class="mt-4 p-3 rounded-lg text-center flex flex-col items-center justify-center" style="background: linear-gradient(45deg, var(--primary-color), #4a00e0);">
                <div id="motivational-phrase-content" class="text-white font-semibold text-sm">
                    <!-- Motivational phrase will be injected here -->
                </div>
            </div>

            <!-- Current Station Label -->
            <div id="station-display-container" class="text-center -mt-2">
                 <p id="current-station-label" class="text-sm font-semibold opacity-80"></p>
            </div>

            <!-- Audio element (hidden) -->
            <audio id="radio-player" crossorigin="anonymous"></audio>

            <!-- Radio Controls -->
            <div class="flex flex-col space-y-4" id="radio-controls">
                <div class="flex items-center justify-center space-x-4">
                    <button id="play-pause-btn" class="text-4xl w-16 h-16 flex items-center justify-center rounded-full btn-primary shadow-lg">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-volume-down"></i>
                    <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    <i class="fas fa-volume-up"></i>
                </div>
            </div>
            
            <!-- Action Icons -->
            <div class="grid grid-cols-4 sm:grid-cols-6 gap-2 text-center text-xs">
                 <div class="flex flex-col items-center">
                    <button id="change-source-btn" class="btn-icon text-2xl"><i class="fa-solid fa-music"></i></button>
                    <span>Cambiar</span>
                </div>
                <div class="flex flex-col items-center">
                    <button id="vumeter-toggle-btn" class="btn-icon text-2xl"><i class="fa-solid fa-sliders"></i></button>
                    <span>Vúmetro</span>
                </div>
                <div class="flex flex-col items-center">
                    <button id="video-toggle-btn" class="btn-icon text-2xl"><i class="fa-solid fa-tv"></i></button>
                    <span id="video-toggle-label">Ver TV</span>
                </div>
                <div class="flex flex-col items-center">
                     <button id="like-btn" class="btn-icon text-2xl">
                        <i class="far fa-heart"></i>
                    </button>
                    <span id="like-count">0</span>
                </div>
                <div class="flex flex-col items-center">
                    <button id="share-btn" class="btn-icon text-2xl"><i class="fa-solid fa-share-nodes"></i></button>
                    <span>Compartir</span>
                </div>
                 <div class="flex flex-col items-center">
                    <a href="http://www.sintonia102.com" target="_blank" class="btn-icon text-2xl"><i class="fa-solid fa-globe"></i></a>
                    <span>Web</span>
                </div>
            </div>

            <!-- New container for Ephemerides (below icons) -->
            <div id="daily-efemerides-display" class="mt-4 space-y-2 h-16 flex items-center justify-center">
                <!-- Daily ephemerides will be injected here -->
                <p class="text-center text-gray-500 text-sm">Cargando efemérides del día...</p>
            </div>

            <!-- Schedulers -->
            <div class="space-y-4 pt-4 border-t border-[var(--shadow-color)]">
                <!-- Start scheduler -->
                <div class="flex items-center justify-between">
                     <div class="flex items-center space-x-2">
                        <i class="far fa-clock"></i>
                        <input type="datetime-local" id="start-time-input" class="p-1 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                    </div>
                    <button id="set-start-btn" class="btn-primary px-3 py-1 text-sm rounded-md">Programar</button>
                </div>
                 <!-- Stop scheduler -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-stopwatch"></i>
                        <input type="number" id="stop-time-input" placeholder="Minutos" class="p-1 w-24 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                    </div>
                    <button id="set-stop-btn" class="btn-primary px-3 py-1 text-sm rounded-md">Apagar en</button>
                </div>
            </div>
            
             <!-- Message box (for notifications) -->
             <div id="message-box" class="message-box hidden"></div>

        </main>

        <!-- Public Message Board Section -->
        <div class="card w-full max-w-lg rounded-xl p-4 sm:p-6 mt-4 space-y-4">
            <h2 class="text-2xl font-bold" style="color: var(--primary-color);">Mensajes Públicos</h2>
            
            <!-- Admin Controls (hidden by default) -->
            <div id="admin-controls" class="space-y-4 p-4 rounded-lg bg-gray-100 dark:bg-gray-800 hidden">
                <h3 class="text-xl font-semibold">Panel de Administrador</h3>
                
                <!-- Toggle Auto-Publish -->
                <div class="flex items-center justify-between">
                    <span>Publicación Automática:</span>
                    <label class="switch">
                        <input type="checkbox" id="auto-publish-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Prohibited Words Input -->
                <div>
                    <label for="prohibited-words-input" class="block text-sm font-medium mb-1">Palabras Prohibidas (separadas por comas):</label>
                    <input type="text" id="prohibited-words-input" placeholder="ej: malo, feo, grosero" class="w-full p-2 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                    <button id="save-prohibited-words-btn" class="btn-primary px-3 py-1 text-sm rounded-md mt-2">Guardar</button>
                </div>

                <!-- Official Message Input (Updated to separate text and link) -->
                <div>
                    <label for="official-message-text-input" class="block text-sm font-medium mb-1">Texto del Mensaje Oficial:</label>
                    <textarea id="official-message-text-input" rows="2" placeholder="Escribe el texto visible del mensaje oficial aquí..." class="w-full p-2 rounded bg-transparent border border-[var(--shadow-color)] text-sm"></textarea>
                </div>
                <div>
                    <label for="official-message-link-input" class="block text-sm font-medium mb-1">URL del Enlace (opcional):</label>
                    <input type="url" id="official-message-link-input" placeholder="https://ejemplo.com" class="w-full p-2 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                </div>
                <div>
                    <label for="official-message-link-display-text-input" class="block text-sm font-medium mb-1">Texto a enlazar (debe estar en el mensaje oficial):</label>
                    <input type="text" id="official-message-link-display-text-input" placeholder="Ej: Visita nuestra web" class="w-full p-2 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                    <p class="text-xs text-gray-500 mt-1">Si este texto no se encuentra en el mensaje, o si la URL está vacía, no se generará un enlace.</p>
                    <button id="publish-official-message-btn" class="btn-primary px-3 py-1 text-sm rounded-md mt-2">Publicar Mensaje Oficial</button>
                </div>

                <h4 class="text-lg font-semibold mt-4">Mensajes Pendientes y Ocultos:</h4>
                <div id="pending-messages-list" class="space-y-2">
                    <!-- Pending and hidden messages will be loaded here -->
                    <p class="text-center text-gray-500 text-sm">No hay mensajes pendientes ni ocultos.</p>
                </div>
            </div>

            <!-- Message Input Form -->
            <div class="space-y-2">
                <input type="text" id="message-name-input" placeholder="Tu nombre" class="w-full p-2 rounded bg-transparent border border-[var(--shadow-color)] text-sm">
                <textarea id="message-text-input" rows="3" placeholder="Escribe tu mensaje aquí..." class="w-full p-2 rounded bg-transparent border border-[var(--shadow-color)] text-sm"></textarea>
                <button id="submit-message-btn" class="btn-primary w-full py-2 rounded-md">Enviar Mensaje</button>
            </div>

            <!-- Display Public Messages -->
            <div id="public-messages-list" class="space-y-3 pt-4 border-t border-[var(--shadow-color)]">
                <!-- Public messages will be loaded here -->
                <p class="text-center text-gray-500 text-sm">Sé el primero en dejar un mensaje!</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import necessary functions from Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, arrayRemove, collection, addDoc, deleteDoc, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Elements ---
            const radioPlayer = document.getElementById('radio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const volumeSlider = document.getElementById('volume-slider');
            const changeSourceBtn = document.getElementById('change-source-btn');
            const vumeterToggleBtn = document.getElementById('vumeter-toggle-btn');
            const videoToggleBtn = document.getElementById('video-toggle-btn');
            const videoToggleLabel = document.getElementById('video-toggle-label');
            const likeBtn = document.getElementById('like-btn');
            const likeCountSpan = document.getElementById('like-count');
            const shareBtn = document.getElementById('share-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const messageBox = document.getElementById('message-box');
            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            const currentStationLabel = document.getElementById('current-station-label');
            const playerDisplay = document.getElementById('player-display'); 
            const startTimeInput = document.getElementById('start-time-input');
            const setStartBtn = document.getElementById('set-start-btn');
            const stopTimeInput = document.getElementById('stop-time-input');
            const setStopBtn = document.getElementById('set-stop-btn');
            const motivationalPhraseContentDiv = document.getElementById('motivational-phrase-content');
            const dailyEfeméridesDisplay = document.getElementById('daily-efemerides-display');

            // --- New Message Board DOM Elements ---
            const adminToggleBtn = document.getElementById('admin-toggle-btn');
            const adminControlsDiv = document.getElementById('admin-controls');
            const autoPublishToggle = document.getElementById('auto-publish-toggle');
            const prohibitedWordsInput = document.getElementById('prohibited-words-input');
            const saveProhibitedWordsBtn = document.getElementById('save-prohibited-words-btn');
            // Updated DOM elements for official message input
            const officialMessageTextInput = document.getElementById('official-message-text-input');
            const officialMessageLinkInput = document.getElementById('official-message-link-input');
            const officialMessageLinkDisplayText = document.getElementById('official-message-link-display-text-input'); 
            const publishOfficialMessageBtn = document.getElementById('publish-official-message-btn');
            const messageNameInput = document.getElementById('message-name-input');
            const messageTextInput = document.getElementById('message-text-input');
            const submitMessageBtn = document.getElementById('submit-message-btn');
            const publicMessagesList = document.getElementById('public-messages-list');
            const pendingMessagesList = document.getElementById('pending-messages-list');
            const signInGoogleBtn = document.getElementById('sign-in-google-btn'); 

            // --- LOCAL EPHEMERIDES DATA (Replaces Firebase) ---
            const localEphemeridesData = {
                "01-01": ["Triunfo de la Revolución Cubana (1959): Las fuerzas lideradas por Fidel Castro entran en La Habana, marcando el fin de la dictadura de Fulgencio Batista.","Ocupación Británica de las Malvinas (1833): Una corbeta británica expulsa a las autoridades argentinas y a los pobladores de las Islas Malvinas, iniciando la ocupación ilegal del archipiélago.","Entrada en vigor del Mercosur (1995): El Mercado Común del Sur, integrado por Argentina, Brasil, Paraguay y Uruguay, entra en plena vigencia.","Proclamación de la Emancipación en EE.UU. (1863): Abraham Lincoln declara libres a los esclavos en los estados confederados.","Independencia de Haití (1804): Haití se convierte en la primera república negra del mundo y la segunda nación independiente de América.","Entrada en circulación del Euro (2002): Los billetes y monedas de euro entran en circulación en 12 países de la Unión Europea.",'Nacimiento de J. D. Salinger (1919): Nace en Nueva York el escritor estadounidense, autor de "El guardián entre el centeno".',"Fundación de la Organización Mundial del Comercio (OMC) (1995): Se establece el organismo que supervisa el comercio internacional.","Día del Dominio Público: Cada año, obras de autores fallecidos hace un determinado tiempo pasan a ser de dominio público.","Año Nuevo: Celebración global que marca el inicio de un nuevo año en el calendario gregoriano."],
                "01-02": ['Nacimiento de Carlos "Lole" Reutemann (1942): Nace en Santa Fe el destacado piloto de Fórmula 1 y posterior gobernador de su provincia.',"Toma de Granada (1492): Los Reyes Católicos conquistan el Reino de Granada, último bastión musulmán en la Península Ibérica.","Nacimiento de Isaac Asimov (1920): Nace en Rusia el prolífico escritor y divulgador científico, maestro de la ciencia ficción.","Primer alunizaje suave de una sonda (1959): La sonda soviética Luna 1 se convierte en la primera nave en escapar de la gravedad terrestre.","Japón captura Manila (1942): Durante la Segunda Guerra Mundial, las tropas japonesas ocupan la capital de Filipinas.",'Fallecimiento de Fausto Coppi (1960): Muere el legendario ciclista italiano, apodado "Il Campionissimo".',"Día Internacional del Policía: Se rinde homenaje a los oficiales de policía caídos en cumplimiento de su deber.","Se funda el Racing Club (1903): Se funda en Avellaneda uno de los cinco grandes del fútbol argentino.","Luis Muñoz Marín se convierte en el primer gobernador de Puerto Rico (1949): Es el primer gobernador elegido democráticamente en la isla.","Se declara monumento histórico la casa de Domingo F. Sarmiento (1910): La casa natal del prócer en San Juan es protegida por su valor histórico."],
                "01-03": ["Combate de San Lorenzo (1813): Las fuerzas lideradas por José de San Martín obtienen una victoria clave en su única batalla en territorio argentino.",'Nacimiento de J.R.R. Tolkien (1892): Nace en Sudáfrica el escritor británico, autor de "El Hobbit" y "El Señor de los Anillos".',"Excomunión de Martín Lutero (1521): El Papa León X excomulga a Martín Lutero por sus críticas a la Iglesia Católica.","Nacimiento de Mel Gibson (1956): Nace en Nueva York el actor y director de cine.","Alaska se convierte en el 49º estado de EE.UU. (1959): Se formaliza la admisión de Alaska a la Unión.","Fundación de Apple Computer (1977): Steve Jobs, Steve Wozniak y Mike Markkula fundan formalmente la compañía.","Fallecimiento de Jack Ruby (1967): Muere el hombre que asesinó a Lee Harvey Oswald, el presunto asesino de John F. Kennedy.","Nacimiento de Michael Schumacher (1969): Nace en Alemania el siete veces campeón del mundo de Fórmula 1.","Panamá asume el control total del Canal (1990): De acuerdo a los Tratados Torrijos-Carter, Panamá toma el control administrativo del canal.","Se patenta la pajita para beber (1888): Marvin C. Stone patenta la pajita de papel."],
                "06-26": ["Día Internacional de la Lucha contra el Uso Indebido y el Tráfico Ilícito de Drogas.","Día Internacional de las Naciones Unidas en Apoyo de las Víctimas de la Tortura.","Se publica por primera vez 'Harry Potter y la piedra filosofal' (1997).","Nacimiento de Salvador Allende (1908), ex-presidente de Chile.","Nacimiento de Pearl S. Buck (1892), escritora estadounidense, Premio Nobel de Literatura.","Nacimiento de Ariana Grande (1993), cantante y actriz estadounidense."],
                "11-05": ["Primer día de emisión al Aire de Radio Sintonia 102.5 FM (2011): Comenzaba la historia de la radio más escuchada en Monte Maíz. Gracias Por elegirnos y apoyarnos."],
                "12-31": ["Nochevieja / Víspera de Año Nuevo: Celebración global que marca el fin de un año y la espera del siguiente.","Se entrega el Canal de Panamá a Panamá (1999): Estados Unidos transfiere el control total del canal a Panamá, en cumplimiento de los Tratados Torrijos-Carter.","Se funda la Compañía Británica de las Indias Orientales (1600).","Thomas Edison demuestra la luz incandescente (1879): Realiza la primera demostración pública de su bombilla.","Fallecimiento de Miguel de Unamuno (1936).","Se retira el Plan Marshall (1951).","Nacimiento de Henri Matisse (1869).","Boris Yeltsin renuncia a la presidencia de Rusia (1999): Deja a Vladimir Putin como presidente interino.","Fallecimiento de George Marshall (1959).",'Se estrena "El Padrino II" (1974).']
            };
            
            // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyDomYzzPU9zxP9KdMGKvOrrNlwt0RLVE7Y",
                authDomain: "appsintonia-66989.firebaseapp.com",
                projectId: "appsintonia-66989",
                storageBucket: "appsintonia-66989.firebasestorage.app",
                messagingSenderId: "61116779380",
                appId: "1:61116779380:web:e42c0f702296b17b153a21"
            };
            
            // Determine the app ID for Firestore based on environment or fallback to default
            const appIdForFirestore = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;

            let app, db, auth;
            let userId = 'anonymous'; 
            let globalLikeDocRef = null; 
            let adminSettingsDocRef = null;
            let messagesCollectionRef = null;
            let adminUserDocRef = null; 
            let isAdmin = false;
            let currentOfficialMessageDocId = null; 

            // Function to display messages (notifications)
            function showMessage(text, isError = false, duration = 3000) {
                messageBox.textContent = text;
                messageBox.classList.remove('hidden', 'show', 'error');
                if (isError) {
                    messageBox.classList.add('error');
                }
                // Trigger reflow to restart animation
                void messageBox.offsetWidth; 
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.classList.add('hidden'), 300); 
                }, duration);
            }

            // Function to handle Google Sign-In
            async function signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    showMessage("Sesión de administrador iniciada con Google.", false);
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                    showMessage(`Error al iniciar sesión con Google: ${error.message}`, true);
                }
            }

            try {
                // Initialize Firebase app and services
                const currentFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user (with custom token if available, otherwise anonymously)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => { 
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Set up Firestore document references after user is authenticated
                        globalLikeDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/radioLikes/globalLikeCount`);
                        adminSettingsDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/adminSettings/config`);
                        messagesCollectionRef = collection(db, `artifacts/${appIdForFirestore}/public/data/messages`);
                        adminUserDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/adminConfig/adminUser`); 

                        await loadAdminUserConfig(); 

                        if (isAdmin) {
                            adminToggleBtn.classList.remove('hidden');
                            adminToggleBtn.classList.add('admin-active-btn'); 
                            signInGoogleBtn.classList.add('hidden'); // Hide sign-in button if admin is already active
                        } else {
                            adminToggleBtn.classList.add('hidden');
                            adminToggleBtn.classList.remove('admin-active-btn'); 
                            if (user.isAnonymous) { 
                                signInGoogleBtn.classList.remove('hidden'); // Show sign-in button if anonymous
                            } else {
                                signInGoogleBtn.classList.add('hidden'); // Hide sign-in button if not anonymous (i.e., signed in with non-admin Google account)
                            }
                        }

                        setupLikesListener();
                        loadAdminSettings(); 
                        loadMessages(); 
                    } else {
                        console.log("No user is signed in.");
                        userId = 'anonymous';
                        isAdmin = false;
                        adminToggleBtn.classList.add('hidden');
                        adminToggleBtn.classList.remove('admin-active-btn'); 
                        signInGoogleBtn.classList.remove('hidden'); // Show sign-in button if user is anonymous and not an admin
                        showMessage("No se pudo autenticar. Algunas funciones pueden estar limitadas.", true);
                    }
                    loadDailyEfemérides(); 
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showMessage("Error al iniciar la base de datos. Las funciones avanzadas no estarán disponibles.", true, 8000);
                loadDailyEfemérides(); 
            }

            // --- Audio Streams ---
            const streams = [
                { name: "SINTONIA", url: "https://stream.radioservice.org/8046/stream" },
                { name: "SINTONIA 2", url: "https://stream.zeno.fm/40x1zezb7nhvv" }
            ];
            let currentStreamIndex = 0;

            // --- Vumeter Configuration ---
            let audioCtx, analyser, source, dataArray, bufferLength;
            let currentVumeterEffect = 0;
            const totalVumeterEffects = 10;
            let animationFrameId;

            // --- Motivational Phrases ---
            const motivationalPhrases = [
                "Cree que puedes y ya estás a medio camino.", "El mejor momento para plantar un árbol fue hace 20 años. El segundo mejor momento es ahora.", "Tu actitud, no tu aptitud, determinará tu altitud.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "La única forma de hacer un gran trabajo es amar lo que haces."
            ];

            // --- Application State ---
            let isPlaying = false;
            let isVideoActive = false; 
            let startTimeout, stopTimeout;
            let dailyEfemerides = [];
            let dailyEfemeridesIntervalId;
            let prohibitedWords = [];
            let autoPublishEnabled = true;

            // --- Audio Context Setup ---
            function setupAudioContext() {
                if (audioCtx) return; 
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 2048; 
                    source = audioCtx.createMediaElementSource(radioPlayer); 
                    source.connect(analyser); 
                    analyser.connect(audioCtx.destination); 
                    bufferLength = analyser.frequencyBinCount; 
                    dataArray = new Uint8Array(bufferLength); 
                } catch (e) {
                    console.error("Error configuring audio context:", e);
                    showMessage("El navegador no soporta el vúmetro.", true);
                }
            }

            // --- Radio Playback Functions ---
            function playRadio() {
                if (isPlaying) return;
                if (!audioCtx) setupAudioContext();

                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                radioPlayer.play().then(() => {
                    isPlaying = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; 
                    if (!isVideoActive) draw(); 
                }).catch(e => {
                    console.error("Error playing audio:", e);
                    showMessage("No se pudo iniciar la radio. Interactúa con la página primero.", true);
                });
            }

            function pauseRadio() {
                if (!isPlaying) return; 
                radioPlayer.pause();
                cancelAnimationFrame(animationFrameId); 
                isPlaying = false;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; 
            }

            function togglePlayPause() {
                if (isPlaying) pauseRadio();
                else playRadio();
            }
            
            function toggleAudioSource() {
                const wasPlaying = isPlaying;
                if(wasPlaying) pauseRadio(); 
                currentStreamIndex = (currentStreamIndex + 1) % streams.length; 
                const newStream = streams[currentStreamIndex]; 
                radioPlayer.src = newStream.url;
                radioPlayer.load(); 
                updateStationLabel(); 
                showMessage(`Cambiando a ${newStream.name}`, false, 2000);
                if (wasPlaying) {
                    radioPlayer.addEventListener('canplay', () => playRadio(), { once: true });
                }
            }
            
            function updateStationLabel() {
                 currentStationLabel.textContent = `Ahora suena: ${streams[currentStreamIndex].name}`;
            }
            
            function toggleVideo() {
                isVideoActive = !isVideoActive; 
                let videoContainer = document.getElementById('videoContainer'); 
                if (isVideoActive) {
                    if (isPlaying) pauseRadio(); 
                    cancelAnimationFrame(animationFrameId); 
                    canvas.classList.add('hidden'); 
                    
                    if (!videoContainer) {
                        videoContainer = document.createElement('div');
                        videoContainer.id = 'videoContainer';
                        videoContainer.classList.add('video-container-dynamic'); 
                        playerDisplay.appendChild(videoContainer); 
                    }
                    
                    videoContainer.innerHTML = `<iframe src="https://player.kick.com/sintonia-tv" height="100%" width="100%" frameborder="0" scrolling="no" allowfullscreen="true" allow="autoplay; encrypted-media; picture-in-picture"></iframe>`;
                    videoToggleLabel.textContent = "Escuchar Radio";
                    videoToggleBtn.innerHTML = '<i class="fa-solid fa-radio"></i>';
                } else {
                    if (videoContainer) videoContainer.remove(); 
                    canvas.classList.remove('hidden'); 
                    videoToggleLabel.textContent = "Ver TV";
                    videoToggleBtn.innerHTML = '<i class="fa-solid fa-tv"></i>';
                    playRadio(); 
                }
            }

            function changeVumeterEffect() {
                currentVumeterEffect = (currentVumeterEffect + 1) % totalVumeterEffects; 
                showMessage(`Vúmetro Efecto ${currentVumeterEffect + 1}`, false, 1500); 
            }

            // --- Likes Feature (Firebase) ---
            function setupLikesListener() {
                if (!globalLikeDocRef) return;
                onSnapshot(globalLikeDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        likeCountSpan.textContent = `${docSnap.data().count || 0} Me Gusta`;
                    } else {
                        setDoc(globalLikeDocRef, { count: 0 });
                    }
                }, console.error);
            }
            
            async function handleLike() {
                if (!globalLikeDocRef) return showMessage("La función de 'Me Gusta' no está disponible.", true);
                try {
                    await updateDoc(globalLikeDocRef, { count: increment(1) });
                    likeBtn.querySelector('i').classList.replace('far', 'fas'); 
                    likeBtn.querySelector('i').classList.add('text-red-500'); 
                    showMessage("¡Gracias por tu Me Gusta!", false);
                } catch (e) {
                    console.error("Error registering like:", e);
                    showMessage("Error al registrar tu 'Me Gusta'.", true);
                }
            }

            // --- Share Feature ---
            function handleShare() {
                if (navigator.share) { 
                    navigator.share({ title: 'SINTONIA Radio', text: '¡Escuchá la mejor radio online!', url: window.location.href });
                } else {
                    navigator.clipboard.writeText(window.location.href); 
                    showMessage('¡Link copiado al portapapeles!', false);
                }
            }
            
            // --- Theme Toggle ---
            function handleThemeToggle() {
                document.documentElement.classList.toggle('dark'); 
                document.documentElement.classList.toggle('light'); 
            }

            // --- Scheduler Logic ---
            setStartBtn.addEventListener('click', () => {
                const targetTime = new Date(startTimeInput.value).getTime(); 
                const delay = targetTime - Date.now(); 
                if (delay <= 0) return showMessage("La hora seleccionada ya pasó.", true);
                clearTimeout(startTimeout); 
                startTimeout = setTimeout(() => playRadio(), delay);
                showMessage(`Radio programada para iniciar en ${new Date(targetTime).toLocaleString()}`, false);
            });

            setStopBtn.addEventListener('click', () => {
                const minutes = parseInt(stopTimeInput.value, 10); 
                if (isNaN(minutes) || minutes <= 0) return showMessage("Ingresa un número válido de minutos.", true);
                const delay = minutes * 60 * 1000; 
                clearTimeout(stopTimeout); 
                stopTimeout = setTimeout(() => pauseRadio(), delay);
                showMessage(`La radio se apagará en ${minutes} minuto(s).`, false);
            });

            // --- Motivational Phrase Logic (Local Storage) ---
            function loadMotivationalPhrase() { 
                const today = new Date().toDateString();
                let lastDate = localStorage.getItem('lastPhraseDate');
                let phraseIndex = parseInt(localStorage.getItem('phraseIndex') || '0');

                if (today !== lastDate) {
                    phraseIndex = (phraseIndex + 1) % motivationalPhrases.length;
                    localStorage.setItem('phraseIndex', phraseIndex.toString()); 
                    localStorage.setItem('lastPhraseDate', today);
                }
                
                motivationalPhraseContentDiv.textContent = motivationalPhrases[phraseIndex]; 
            }

            // --- Daily Ephemerides Logic (Local Data) ---
            function loadDailyEfemérides() {
                const today = new Date();
                const day = today.getDate();
                const monthIndex = today.getMonth();
                
                const monthForData = String(monthIndex + 1).padStart(2, '0');
                const dayForData = String(day).padStart(2, '0');
                const docKey = `${monthForData}-${dayForData}`;

                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const monthName = monthNames[monthIndex];
                const formattedDate = `${day} de ${monthName}`;

                dailyEfemerides = localEphemeridesData[docKey] || [];

                if (dailyEfemerides.length > 0) {
                    startDailyEfemeridesRotation(formattedDate);
                } else {
                    dailyEfeméridesDisplay.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay efemérides para hoy.</p>';
                }
            }

            function startDailyEfemeridesRotation(formattedDate) {
                if (dailyEfemeridesIntervalId) clearInterval(dailyEfemeridesIntervalId);
                if (dailyEfemerides.length === 0) return;

                const efemeridesColors = [
                    'linear-gradient(45deg, #2980b9, #3498db)',
                    'linear-gradient(45deg, #c0392b, #e74c3c)',
                    'linear-gradient(45deg, #27ae60, #2ecc71)',
                    'linear-gradient(45deg, #8e44ad, #9b59b6)',
                    'linear-gradient(45deg, #d35400, #e67e22)',
                    'linear-gradient(45deg, #16a085, #1abc9c)',
                    'linear-gradient(45deg, #f39c12, #f1c40f)',
                    'linear-gradient(45deg, #2c3e50, #34495e)'
                ];
                
                let currentIndex = 0;
                const updateDisplay = () => {
                    const currentColor = efemeridesColors[currentIndex % efemeridesColors.length];
                    
                    dailyEfeméridesDisplay.innerHTML = `
                        <div class="efemeride-fade w-full" style="background: ${currentColor}; padding: 0.75rem; border-radius: 0.5rem; text-align: center; color: white;">
                            <p class="font-bold text-md">${formattedDate}</p>
                            <p class="font-semibold text-sm mt-1">${dailyEfemerides[currentIndex]}</p>
                        </div>`;
                    currentIndex = (currentIndex + 1) % dailyEfemerides.length;
                };

                updateDisplay(); 
                dailyEfemeridesIntervalId = setInterval(updateDisplay, 8000); 
            }
            
            // --- Vumeter Drawing Functions ---
            function draw() {
                if (!isPlaying || isVideoActive || !analyser) return;
                animationFrameId = requestAnimationFrame(draw); 
                analyser.getByteFrequencyData(dataArray); 
                canvasCtx.fillStyle = '#000'; 
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height); 

                switch (currentVumeterEffect) {
                    case 0: drawBars(); break;
                    case 1: drawCircular(); break;
                    case 2: drawWave(); break;
                    case 3: drawLineGraph(); break;
                    case 4: drawMirrorBars(); break;
                    case 5: drawRadialBars(); break;
                    case 6: drawDotGrid(); break;
                    case 7: drawExpandingCircle(); break;
                    case 8: drawSpiral(); break;
                    case 9: drawParticleSystem(); break;
                    default: drawBars(); 
                }
            }
            
            const drawBars = () => {
                const barWidth = (canvas.width / bufferLength) * 2.5; 
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i]; 
                    const hue = i * 2; 
                    canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight); 
                    x += barWidth + 1; 
                }
            };

            const drawCircular = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) * 0.4; 
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2; 
                    const angle = (i / bufferLength) * 2 * Math.PI; 
                    const xStart = centerX + radius * Math.cos(angle);
                    const yStart = centerY + radius * Math.sin(angle);
                    const xEnd = centerX + (radius + barHeight) * Math.cos(angle);
                    const yEnd = centerY + (radius + barHeight) * Math.sin(angle);
                    canvasCtx.strokeStyle = `hsl(${i * 3}, 100%, 70%)`;
                    canvasCtx.lineWidth = 2;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(xStart, yStart);
                    canvasCtx.lineTo(xEnd, yEnd);
                    canvasCtx.stroke();
                }
            };
            
            const drawWave = () => {
                analyser.getByteTimeDomainData(dataArray); 
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = `hsl(${Date.now() / 20 % 360}, 100%, 50%)`; 
                canvasCtx.beginPath();
                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0; 
                    const y = v * canvas.height / 2; 
                    if (i === 0) canvasCtx.moveTo(x, y);
                    else canvasCtx.lineTo(x, y);
                    x += sliceWidth;
                }
                canvasCtx.lineTo(canvas.width, canvas.height / 2);
                canvasCtx.stroke();
            };

            const drawLineGraph = () => {
                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = `hsl(${Date.now() / 30 % 360}, 80%, 60%)`;
                canvasCtx.beginPath();
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 255.0;
                    const y = v * canvas.height;
                    if (i === 0) {
                        canvasCtx.moveTo(x, y);
                    } else {
                        canvasCtx.lineTo(x, y);
                    }
                    x += sliceWidth;
                }
                canvasCtx.stroke();
            };

            const drawMirrorBars = () => {
                const barWidth = (canvas.width / bufferLength) * 2;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] * 0.8;
                    const hue = i * 2;
                    canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    canvasCtx.fillRect(x, canvas.height / 2 - barHeight, barWidth, barHeight);
                    canvasCtx.fillRect(x, canvas.height / 2, barWidth, barHeight);
                    x += barWidth + 1;
                }
            };

            const drawRadialBars = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const maxRadius = Math.min(centerX, centerY) * 0.8;
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 255.0 * maxRadius;
                    const angle = (i / bufferLength) * 2 * Math.PI;
                    const x = centerX + barHeight * Math.cos(angle);
                    const y = centerY + barHeight * Math.sin(angle);
                    canvasCtx.strokeStyle = `hsl(${i * 3}, 100%, 60%)`;
                    canvasCtx.lineWidth = 2;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(centerX, centerY);
                    canvasCtx.lineTo(x, y);
                    canvasCtx.stroke();
                }
            };

            const drawDotGrid = () => {
                const dotSize = 3;
                const spacing = 15;
                for (let y = spacing; y < canvas.height; y += spacing) {
                    for (let x = spacing; x < canvas.width; x += spacing) {
                        const i = Math.floor((x / canvas.width) * bufferLength);
                        const intensity = dataArray[i] / 255.0;
                        canvasCtx.fillStyle = `rgba(255, 255, 255, ${intensity})`;
                        canvasCtx.beginPath();
                        canvasCtx.arc(x, y, dotSize * intensity, 0, Math.PI * 2);
                        canvasCtx.fill();
                    }
                }
            };

            const drawExpandingCircle = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const avgAmplitude = dataArray.reduce((acc, val) => acc + val, 0) / bufferLength;
                const radius = avgAmplitude * 0.8;
                canvasCtx.strokeStyle = `hsl(${avgAmplitude * 2 % 360}, 100%, 70%)`;
                canvasCtx.lineWidth = 3;
                canvasCtx.beginPath();
                canvasCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                canvasCtx.stroke();
            };

            const drawSpiral = () => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = `hsl(${Date.now() / 40 % 360}, 100%, 60%)`;
                canvasCtx.beginPath();
                for (let i = 0; i < bufferLength; i++) {
                    const amplitude = dataArray[i] / 255.0;
                    const angle = (i / bufferLength) * Math.PI * 10; 
                    const radius = amplitude * Math.min(centerX, centerY) * 0.8;
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    if (i === 0) {
                        canvasCtx.moveTo(x, y);
                    } else {
                        canvasCtx.lineTo(x, y);
                    }
                }
                canvasCtx.stroke();
            };

            const drawParticleSystem = () => {
                const particles = [];
                const maxParticles = 100;
                const particleSize = 2;

                for (let i = 0; i < bufferLength; i += Math.floor(bufferLength / maxParticles)) {
                    const amplitude = dataArray[i] / 255.0;
                    if (amplitude > 0.1) { 
                        particles.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            vx: (Math.random() - 0.5) * 2 * amplitude * 5,
                            vy: (Math.random() - 0.5) * 2 * amplitude * 5,
                            color: `hsl(${i * 2 % 360}, 100%, 70%)`,
                            life: 100, 
                            maxLife: 100
                        });
                    }
                }

                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;

                    if (p.life <= 0) {
                        particles.splice(i, 1);
                        i--;
                        continue;
                    }

                    canvasCtx.globalAlpha = p.life / p.maxLife;
                    canvasCtx.fillStyle = p.color;
                    canvasCtx.beginPath();
                    canvasCtx.arc(p.x, p.y, particleSize * (p.life / p.maxLife), 0, Math.PI * 2);
                    canvasCtx.fill();
                }
                canvasCtx.globalAlpha = 1; 
            };


            // --- Admin Settings Logic (Firebase) ---
            async function loadAdminUserConfig() {
                if (!adminUserDocRef) return;
                try {
                    const docSnap = await getDoc(adminUserDocRef);
                    if (docSnap.exists()) {
                        const adminConfig = docSnap.data();
                        const adminGoogleUids = adminConfig.adminGoogleUids || []; 
                        isAdmin = adminGoogleUids.includes(userId); 
                    } else {
                        console.warn("No admin user ID(s) configured in Firestore. Admin panel will not be available.");
                        isAdmin = false;
                    }
                } catch (e) {
                    console.error("Error loading admin user config:", e);
                    showMessage("Error al cargar la configuración de administrador.", true);
                    isAdmin = false;
                }
            }

            async function loadAdminSettings() {
                if (!adminSettingsDocRef) return;
                onSnapshot(adminSettingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        autoPublishEnabled = settings.autoPublish || false;
                        prohibitedWords = (settings.prohibitedWords || "").split(',').map(word => word.trim()).filter(word => word.length > 0);
                        
                        if (isAdmin) {
                            autoPublishToggle.checked = autoPublishEnabled;
                            prohibitedWordsInput.value = settings.prohibitedWords || "";
                        }
                    } else {
                        setDoc(adminSettingsDocRef, { autoPublish: true, prohibitedWords: "" });
                        autoPublishEnabled = true;
                        prohibitedWords = [];
                    }
                }, console.error);
            }

            async function handleSaveProhibitedWords() {
                if (!isAdmin || !adminSettingsDocRef) return showMessage("Acceso denegado.", true);
                const words = prohibitedWordsInput.value.split(',').map(word => word.trim()).filter(word => word.length > 0).join(',');
                try {
                    await updateDoc(adminSettingsDocRef, { prohibitedWords: words });
                    showMessage("Palabras prohibidas guardadas.", false);
                } catch (e) {
                    console.error("Error saving prohibited words:", e);
                    showMessage("Error al guardar palabras prohibidas.", true);
                }
            }

            async function handleAutoPublishToggle() {
                if (!isAdmin || !adminSettingsDocRef) return showMessage("Acceso denegado.", true);
                try {
                    await updateDoc(adminSettingsDocRef, { autoPublish: autoPublishToggle.checked });
                    showMessage(`Publicación automática: ${autoPublishToggle.checked ? 'Activada' : 'Desactivada'}`, false);
                } catch (e) {
                    console.error("Error toggling auto publish:", e);
                    showMessage("Error al cambiar publicación automática.", true);
                }
            }

            // --- Message Board Logic (Firebase) ---
            function containsProhibitedWords(message) {
                const lowerCaseMessage = message.toLowerCase();
                return prohibitedWords.some(word => lowerCaseMessage.includes(word.toLowerCase()));
            }

            async function handleSubmitMessage() {
                const name = messageNameInput.value.trim();
                const message = messageTextInput.value.trim();

                if (!name || !message) {
                    return showMessage("Por favor, ingresa tu nombre y un mensaje.", true);
                }

                let status = 'approved';
                if (containsProhibitedWords(message)) {
                    status = 'pending';
                    showMessage("Tu mensaje contiene palabras prohibidas y está pendiente de aprobación del administrador.", true, 5000);
                } else if (!autoPublishEnabled) {
                    status = 'pending';
                    showMessage("Tu mensaje está pendiente de aprobación del administrador.", false, 5000);
                } else {
                    showMessage("Mensaje enviado con éxito.", false);
                }

                try {
                    await addDoc(messagesCollectionRef, {
                        name: name,
                        message: message,
                        timestamp: Date.now(),
                        status: status,
                        isOfficial: false,
                        userId: userId,
                        likes: 0, 
                        likedBy: [],
                        dislikes: 0, 
                        dislikedBy: [] 
                    });
                    messageNameInput.value = '';
                    messageTextInput.value = '';
                } catch (e) {
                    console.error("Error adding message:", e);
                    showMessage("Error al enviar el mensaje.", true);
                }
            }

            async function handlePublishOfficialMessage() {
                if (!isAdmin || !messagesCollectionRef) return showMessage("Acceso denegado.", true);
                const officialText = officialMessageTextInput.value.trim();
                let officialLink = officialMessageLinkInput.value.trim(); 
                const officialLinkDisplayText = officialMessageLinkDisplayText.value.trim();

                if (!officialText) {
                    return showMessage("Por favor, ingresa el texto del mensaje oficial.", true);
                }

                // Prepend https:// if missing for absolute URL
                if (officialLink && !/^https?:\/\//i.test(officialLink)) {
                    officialLink = `https://${officialLink}`;
                }

                let messageToStore = officialText;
                if (officialLink && officialLinkDisplayText && officialText.includes(officialLinkDisplayText)) {
                    // Validate URL format
                    const urlRegex = /^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/i;
                    if (!urlRegex.test(officialLink)) {
                        return showMessage("Por favor, ingresa una URL válida (ej: https://ejemplo.com).", true);
                    }
                    
                    // Replace only the first occurrence of the display text with the link
                    const linkedText = `<a href="${officialLink}" target="_blank" rel="noopener noreferrer">${officialLinkDisplayText}</a>`;
                    messageToStore = officialText.replace(officialLinkDisplayText, linkedText);

                } else if (officialLink && officialText) { 
                     const urlRegex = /^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/i;
                    if (!urlRegex.test(officialLink)) {
                        return showMessage("Por favor, ingresa una URL válida (ej: https://ejemplo.com).", true);
                    }
                    messageToStore = `<a href="${officialLink}" target="_blank" rel="noopener noreferrer">${officialText}</a>`;
                }


                try {
                    const messageData = {
                        name: "Administrador SINTONIA",
                        message: messageToStore,
                        officialMessageText: officialText, 
                        officialMessageLink: officialLink, 
                        officialMessageLinkDisplayText: officialLinkDisplayText, 
                        timestamp: Date.now(),
                        status: 'approved', 
                        isOfficial: true,
                        userId: userId,
                        likes: 0, 
                        likedBy: [],
                        dislikes: 0, 
                        dislikedBy: []
                    };

                    // Check if there's an existing official message to update
                    if (currentOfficialMessageDocId) {
                        const officialMsgDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/messages`, currentOfficialMessageDocId);
                        await updateDoc(officialMsgDocRef, messageData);
                        showMessage("Mensaje oficial actualizado.", false);
                    } else {
                        // Add new official message
                        await addDoc(messagesCollectionRef, messageData);
                        showMessage("Mensaje oficial publicado.", false);
                    }
                    officialMessageTextInput.value = '';
                    officialMessageLinkInput.value = '';
                    officialMessageLinkDisplayText.value = ''; 
                    currentOfficialMessageDocId = null; 
                } catch (e) {
                    console.error("Error publishing official message:", e);
                    showMessage("Error al publicar mensaje oficial.", true);
                }
            }

            // Function to update message status (approve/hide/unhide)
            async function updateMessageStatus(messageId, newStatus) {
                if (!isAdmin || !messagesCollectionRef) return showMessage("Acceso denegado.", true);
                try {
                    const msgDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/messages`, messageId);
                    await updateDoc(msgDocRef, { status: newStatus });
                    showMessage(`Mensaje ${newStatus === 'approved' ? 'aprobado/mostrado' : 'ocultado'}.`, false);
                } catch (e) {
                    console.error("Error updating message status:", e);
                    showMessage("Error al actualizar el estado del mensaje.", true);
                }
            }

            // Function to delete a message permanently
            async function deleteMessage(messageId) {
                if (!isAdmin || !messagesCollectionRef) return showMessage("Acceso denegado.", true);
                try {
                    const msgDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/messages`, messageId);
                    await deleteDoc(msgDocRef);
                    showMessage("Mensaje eliminado permanentemente.", false);
                } catch (e) {
                    console.error("Error deleting message:", e);
                    showMessage("Error al eliminar mensaje.", true);
                }
            }

            // Function to handle liking a message
            async function handleMessageLike(messageId) {
                if (!messagesCollectionRef || userId === 'anonymous') {
                    return showMessage("Debes iniciar sesión para dar 'Me Gusta'.", true);
                }

                try {
                    const msgDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/messages`, messageId);
                    const docSnap = await getDoc(msgDocRef);

                    if (docSnap.exists()) {
                        const messageData = docSnap.data();
                        const likedBy = messageData.likedBy || [];
                        const dislikedBy = messageData.dislikedBy || [];

                        if (likedBy.includes(userId)) {
                            // User already liked, so unlike it
                            await updateDoc(msgDocRef, {
                                likes: increment(-1),
                                likedBy: arrayRemove(userId)
                            });
                            showMessage("Ya no te gusta este mensaje.", false);
                        } else {
                            // User wants to like
                            let updates = {
                                likes: increment(1),
                                likedBy: arrayUnion(userId)
                            };

                            if (dislikedBy.includes(userId)) {
                                // If previously disliked, remove dislike
                                updates.dislikes = increment(-1);
                                updates.dislikedBy = arrayRemove(userId);
                            }
                            await updateDoc(msgDocRef, updates);
                            showMessage("¡Gracias por tu Me Gusta!", false);
                        }
                    }
                } catch (e) {
                    console.error("Error liking message:", e);
                    showMessage("Error al dar 'Me Gusta' al mensaje.", true);
                }
            }

            // New: Function to handle disliking a message
            async function handleMessageDislike(messageId) {
                if (!messagesCollectionRef || userId === 'anonymous') {
                    return showMessage("Debes iniciar sesión para dar 'No me Gusta'.", true);
                }

                try {
                    const msgDocRef = doc(db, `artifacts/${appIdForFirestore}/public/data/messages`, messageId);
                    const docSnap = await getDoc(msgDocRef);

                    if (docSnap.exists()) {
                        const messageData = docSnap.data();
                        const likedBy = messageData.likedBy || [];
                        const dislikedBy = messageData.dislikedBy || [];

                        if (dislikedBy.includes(userId)) {
                            // User already disliked, so remove dislike
                            await updateDoc(msgDocRef, {
                                dislikes: increment(-1),
                                dislikedBy: arrayRemove(userId)
                            });
                            showMessage("Ya no te disgusta este mensaje.", false);
                        } else {
                            // User wants to dislike
                            let updates = {
                                dislikes: increment(1),
                                dislikedBy: arrayUnion(userId)
                            };

                            if (likedBy.includes(userId)) {
                                // If previously liked, remove like
                                updates.likes = increment(-1);
                                updates.likedBy = arrayRemove(userId);
                            }
                            await updateDoc(msgDocRef, updates);
                            showMessage("¡Mensaje marcado como 'No me Gusta'!", false);
                        }
                    }
                } catch (e) {
                    console.error("Error disliking message:", e);
                    showMessage("Error al dar 'No me Gusta' al mensaje.", true);
                }
            }


            function loadMessages() {
                if (!messagesCollectionRef) return;

                const allMessagesQuery = query(messagesCollectionRef); 

                onSnapshot(allMessagesQuery, (querySnapshot) => {
                    const allMessages = [];
                    querySnapshot.forEach((doc) => {
                        allMessages.push({ id: doc.id, ...doc.data() });
                    });

                    allMessages.sort((a, b) => b.timestamp - a.timestamp);

                    // Find the most recent official message to populate admin panel
                    const latestOfficialMessage = allMessages.find(msg => msg.isOfficial);
                    if (isAdmin && latestOfficialMessage) {
                        officialMessageTextInput.value = latestOfficialMessage.officialMessageText || '';
                        officialMessageLinkInput.value = latestOfficialMessage.officialMessageLink || '';
                        officialMessageLinkDisplayText.value = latestOfficialMessage.officialMessageLinkDisplayText || ''; 
                        currentOfficialMessageDocId = latestOfficialMessage.id; 
                    } else if (isAdmin) {
                        // Clear fields if no official message exists
                        officialMessageTextInput.value = '';
                        officialMessageLinkInput.value = '';
                        officialMessageLinkDisplayText.value = ''; 
                        currentOfficialMessageDocId = null;
                    }


                    // Filter for public (approved) messages
                    const publicMessages = allMessages.filter(msg => msg.status === 'approved');
                    publicMessagesList.innerHTML = ''; 
                    if (publicMessages.length === 0) {
                        publicMessagesList.innerHTML = '<p class="text-center text-gray-500 text-sm">Sé el primero en dejar un mensaje!</p>';
                    } else {
                        publicMessages.forEach((msg) => {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('p-3', 'rounded-lg', 'card');
                            
                            const likesCount = msg.likes || 0;
                            const dislikedCount = msg.dislikes || 0; 
                            const hasLiked = (msg.likedBy || []).includes(userId);
                            const hasDisliked = (msg.dislikedBy || []).includes(userId); 

                            // Determine button states
                            const likeButtonClass = `message-like-btn ${hasLiked ? 'liked' : ''}`;
                            const likeButtonDisabled = hasDisliked ? 'disabled' : ''; 

                            const dislikeButtonClass = `message-dislike-btn ${hasDisliked ? 'disliked' : ''}`;
                            const dislikeButtonDisabled = hasLiked ? 'disabled' : ''; 


                            if (msg.isOfficial) {
                                messageElement.classList.add('official-message');
                                // For official messages, use innerHTML to render HTML content (e.g., links)
                                messageElement.innerHTML = `
                                    <p class="font-bold">${msg.name}</p>
                                    <p class="text-sm mt-1">${msg.message}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(msg.timestamp).toLocaleString()}</p>
                                    <div class="flex items-center mt-2 space-x-2">
                                        <button class="${likeButtonClass}" data-id="${msg.id}" ${likeButtonDisabled}>
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <span>${likesCount}</span>
                                        <button class="${dislikeButtonClass}" data-id="${msg.id}" ${dislikeButtonDisabled}>
                                            <i class="fas fa-thumbs-down"></i>
                                        </button>
                                        <span>${dislikedCount}</span>
                                        ${isAdmin ? `
                                        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 text-xs rounded-md delete-public-btn" data-id="${msg.id}">Eliminar</button>
                                        <button class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 text-xs rounded-md hide-public-btn" data-id="${msg.id}">Ocultar</button>
                                        ` : ''}
                                    </div>
                                `;
                            } else {
                                // For regular user messages, use textContent to prevent XSS attacks
                                messageElement.innerHTML = `
                                    <p class="font-bold">${msg.name}</p>
                                    <p class="text-sm mt-1"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(msg.timestamp).toLocaleString()}</p>
                                    <div class="flex items-center mt-2 space-x-2">
                                        <button class="${likeButtonClass}" data-id="${msg.id}" ${likeButtonDisabled}>
                                            <i class="far fa-heart"></i>
                                        </button>
                                        <span>${likesCount}</span>
                                        <button class="${dislikeButtonClass}" data-id="${msg.id}" ${dislikeButtonDisabled}>
                                            <i class="far fa-thumbs-down"></i>
                                        </button>
                                        <span>${dislikedCount}</span>
                                        ${isAdmin ? `
                                        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 text-xs rounded-md delete-public-btn" data-id="${msg.id}">Eliminar</button>
                                        <button class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 text-xs rounded-md hide-public-btn" data-id="${msg.id}">Ocultar</button>
                                        ` : ''}
                                    </div>
                                `;
                                messageElement.querySelector('p:nth-child(2)').textContent = msg.message;
                            }
                            publicMessagesList.appendChild(messageElement);
                        });

                        // Add event listeners for new public message buttons (only if admin)
                        if (isAdmin) {
                            publicMessagesList.querySelectorAll('.delete-public-btn').forEach(button => {
                                button.addEventListener('click', (e) => deleteMessage(e.target.dataset.id));
                            });
                            publicMessagesList.querySelectorAll('.hide-public-btn').forEach(button => {
                                button.addEventListener('click', (e) => updateMessageStatus(e.target.dataset.id, 'hidden'));
                            });
                        }
                        // Add event listeners for message like buttons
                        publicMessagesList.querySelectorAll('.message-like-btn').forEach(button => {
                            button.addEventListener('click', (e) => handleMessageLike(e.currentTarget.dataset.id));
                        });
                        // Add event listeners for message dislike buttons
                        publicMessagesList.querySelectorAll('.message-dislike-btn').forEach(button => {
                            button.addEventListener('click', (e) => handleMessageDislike(e.currentTarget.dataset.id));
                        });
                    }

                    // Admin-specific: Filter for pending and hidden messages
                    if (isAdmin) {
                        const pendingAndHiddenMessages = allMessages.filter(msg => msg.status === 'pending' || msg.status === 'hidden');
                        pendingMessagesList.innerHTML = ''; 
                        if (pendingAndHiddenMessages.length === 0) {
                            pendingMessagesList.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay mensajes pendientes ni ocultos.</p>';
                        } else {
                            pendingAndHiddenMessages.forEach((msg) => {
                                const messageElement = document.createElement('div');
                                messageElement.classList.add('p-3', 'rounded-lg', 'bg-yellow-100', 'dark:bg-yellow-900', 'border', 'border-yellow-400');
                                messageElement.innerHTML = `
                                    <p class="font-bold">${msg.name} (${msg.status === 'pending' ? 'Pendiente' : 'Oculto'})</p>
                                    <p class="text-sm mt-1">${msg.message}</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-300 mt-1">${new Date(msg.timestamp).toLocaleString()}</p>
                                    <div class="mt-2 space-x-2">
                                        ${msg.status === 'pending' ?
                                            `<button class="btn-primary px-2 py-1 text-xs rounded-md approve-btn" data-id="${msg.id}">Aprobar</button>` :
                                            `<button class="btn-primary px-2 py-1 text-xs rounded-md unhide-btn" data-id="${msg.id}">Mostrar</button>`
                                        }
                                        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 text-xs rounded-md delete-btn" data-id="${msg.id}">Eliminar</button>
                                    </div>
                                `;
                                pendingMessagesList.appendChild(messageElement);
                            });

                            // Add event listeners for approve/unhide/delete buttons after rendering
                            pendingMessagesList.querySelectorAll('.approve-btn').forEach(button => {
                                button.addEventListener('click', (e) => updateMessageStatus(e.target.dataset.id, 'approved'));
                            });
                            pendingMessagesList.querySelectorAll('.unhide-btn').forEach(button => {
                                button.addEventListener('click', (e) => updateMessageStatus(e.target.dataset.id, 'approved'));
                            });
                            pendingMessagesList.querySelectorAll('.delete-btn').forEach(button => {
                                button.addEventListener('click', (e) => deleteMessage(e.target.dataset.id));
                            });
                        }
                    } else {
                        pendingMessagesList.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay mensajes pendientes ni ocultos.</p>';
                    }
                }, console.error);
            }

            // --- Admin Toggle UI ---
            function toggleAdminControls() {
                if (isAdmin) {
                    adminControlsDiv.classList.toggle('hidden');
                    if (!adminControlsDiv.classList.contains('hidden')) {
                        showMessage("Panel de Administrador visible.", false, 2000);
                    } else {
                        showMessage("Panel de Administrador oculto.", false, 2000);
                    }
                } else {
                    showMessage("No tienes permisos de administrador.", true);
                }
            }

            // --- Initialization Function ---
            function init() {
                playPauseBtn.addEventListener('click', togglePlayPause);
                volumeSlider.addEventListener('input', (e) => radioPlayer.volume = e.target.value);
                changeSourceBtn.addEventListener('click', toggleAudioSource);
                vumeterToggleBtn.addEventListener('click', changeVumeterEffect);
                videoToggleBtn.addEventListener('click', toggleVideo);
                likeBtn.addEventListener('click', handleLike);
                shareBtn.addEventListener('click', handleShare);
                themeToggle.addEventListener('change', handleThemeToggle);
                radioPlayer.addEventListener('error', (e) => {
                    console.error("Error en el reproductor:", e.target.error);
                    showMessage(`Error de audio: ${e.target.error.message}`, true, 8000);
                });

                setStartBtn.addEventListener('click', () => {
                    const targetTime = new Date(startTimeInput.value);
                    if (isNaN(targetTime.getTime())) {
                        showMessage("Por favor, selecciona una fecha y hora válidas para programar el inicio.", true);
                        return;
                    }
                    const delay = targetTime.getTime() - Date.now();
                    if (delay <= 0) {
                        showMessage("La hora seleccionada ya pasó.", true);
                        return;
                    }
                    clearTimeout(startTimeout);
                    startTimeout = setTimeout(() => playRadio(), delay);
                    showMessage(`Radio programada para iniciar el ${targetTime.toLocaleString()}`, false);
                });

                setStopBtn.addEventListener('click', () => {
                    const minutes = parseInt(stopTimeInput.value, 10);
                    if (isNaN(minutes) || minutes <= 0) {
                        showMessage("Ingresa un número válido de minutos para apagar.", true);
                        return;
                    }
                    const delay = minutes * 60 * 1000;
                    clearTimeout(stopTimeout);
                    stopTimeout = setTimeout(() => pauseRadio(), delay);
                    showMessage(`La radio se apagará en ${minutes} minuto(s).`, false);
                });

                adminToggleBtn.addEventListener('click', toggleAdminControls);
                autoPublishToggle.addEventListener('change', handleAutoPublishToggle);
                saveProhibitedWordsBtn.addEventListener('click', handleSaveProhibitedWords);
                publishOfficialMessageBtn.addEventListener('click', handlePublishOfficialMessage);
                submitMessageBtn.addEventListener('click', handleSubmitMessage);
                signInGoogleBtn.addEventListener('click', signInWithGoogle); 

                radioPlayer.src = streams[currentStreamIndex].url; 
                updateStationLabel(); 
                
                if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                    themeToggle.checked = false; 
                    document.documentElement.classList.replace('dark', 'light');
                } else {
                    themeToggle.checked = true;
                }
                loadMotivationalPhrase();

                canvas.width = playerDisplay.clientWidth;
                canvas.height = playerDisplay.clientHeight;
                window.addEventListener('resize', () => {
                    canvas.width = playerDisplay.clientWidth;
                    canvas.height = playerDisplay.clientHeight;
                });
            }

            init(); 
        });
    </script>
</body>
</html>
